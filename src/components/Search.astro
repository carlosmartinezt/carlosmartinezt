---
---

<div class="search-container">
  <button class="search-toggle" aria-label="Search entries">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
  </button>

  <div class="search-overlay" aria-hidden="true">
    <div class="search-panel">
      <input
        type="text"
        class="search-input"
        placeholder="Search entries..."
        autocomplete="off"
      />
      <div class="search-results"></div>
    </div>
  </div>
</div>

<style>
  .search-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-toggle {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.1rem;
    line-height: 1;
    color: #fff;
    transition: color 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
  }

  .search-toggle:hover {
    color: #e0e0e0;
  }

  .search-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    z-index: 100;
  }

  .search-overlay.open {
    display: block;
  }

  .search-panel {
    max-width: 600px;
    margin: 5rem auto 0;
    padding: 1.5rem;
    background: var(--bg);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-family: 'Crimson Pro', Georgia, serif;
    font-size: 1.1rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--text);
    outline: none;
    transition: border-color 0.15s ease;
  }

  .search-input:focus {
    border-color: var(--link);
  }

  .search-results {
    margin-top: 0.75rem;
  }

  .search-results:empty {
    margin-top: 0;
  }

  .search-result {
    display: block;
    padding: 0.75rem;
    border-radius: 4px;
    text-decoration: none;
    color: var(--text);
    transition: background-color 0.1s ease;
  }

  .search-result:hover {
    background: var(--bg-subtle);
    color: var(--text);
  }

  .search-result-title {
    font-weight: 600;
    font-size: 1rem;
    margin: 0;
  }

  .search-result-meta {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin: 0.15rem 0 0;
  }

  .search-no-results {
    padding: 0.75rem;
    color: var(--text-secondary);
    font-style: italic;
  }

  @media (max-width: 600px) {
    .search-panel {
      margin: 3.5rem 1rem 0;
    }
  }
</style>

<script>
  function setupSearch() {
    const toggle = document.querySelector('.search-toggle');
    const overlay = document.querySelector('.search-overlay') as HTMLElement;
    const input = document.querySelector('.search-input') as HTMLInputElement;
    const resultsContainer = document.querySelector('.search-results') as HTMLElement;

    if (!toggle || !overlay || !input || !resultsContainer) return;

    let entries: { id: string; title: string; description: string; date: string }[] = [];
    let loaded = false;

    async function loadIndex() {
      if (loaded) return;
      try {
        const res = await fetch('/search-index.json');
        entries = await res.json();
        loaded = true;
      } catch {
        resultsContainer.innerHTML = '<p class="search-no-results">Could not load search data.</p>';
      }
    }

    function openSearch() {
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
      input.value = '';
      resultsContainer.innerHTML = '';
      loadIndex().then(() => input.focus());
    }

    function closeSearch() {
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
    }

    function renderResults(query: string) {
      if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
      }

      const q = query.toLowerCase();
      const matches = entries
        .filter(
          (e) => e.title.toLowerCase().includes(q) || e.description.toLowerCase().includes(q)
        )
        .slice(0, 5);

      if (matches.length === 0) {
        resultsContainer.innerHTML = '<p class="search-no-results">No entries found.</p>';
        return;
      }

      resultsContainer.innerHTML = matches
        .map(
          (e) =>
            `<a class="search-result" href="/${e.id}/">
              <p class="search-result-title">${escapeHtml(e.title)}</p>
              <p class="search-result-meta">${e.date} Â· ${escapeHtml(truncate(e.description, 100))}</p>
            </a>`
        )
        .join('');
    }

    function escapeHtml(str: string) {
      const el = document.createElement('span');
      el.textContent = str;
      return el.innerHTML;
    }

    function truncate(str: string, max: number) {
      return str.length > max ? str.slice(0, max) + '...' : str;
    }

    toggle.addEventListener('click', openSearch);

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeSearch();
    });

    input.addEventListener('input', () => renderResults(input.value));

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && overlay.classList.contains('open')) {
        closeSearch();
      }
    });
  }

  setupSearch();
  document.addEventListener('astro:after-swap', setupSearch);
</script>
